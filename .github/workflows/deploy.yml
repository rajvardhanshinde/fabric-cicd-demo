name: Deploy to Fabric Test

on:
  workflow_dispatch:

jobs:
  deploy-to-fabric-test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Azure Login using Service Principal
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests fabric-cicd pyyaml

      # 5️⃣ Run Fabric Deployment
      - name: Run Fabric Deployment Script
        run: |
          # Use Artifacts YAML if it exists, else default to CLI items
          if [ -f ./parameter.yml ]; then
            echo "[INFO] Using artifacts YAML for deployment"
            python auth_spn_secret_AzDo.py \
              --WorkspaceId ${{ secrets.FABRIC_TEST_WORKSPACE_ID }} \
              --Environment "TEST" \
              --RepositoryDirectory . \
              --ArtifactsYaml ./parameter.yml
          else
            echo "[INFO] Using CLI ItemsInScope for deployment"
            python auth_spn_secret_AzDo.py \
              --WorkspaceId ${{ secrets.FABRIC_TEST_WORKSPACE_ID }} \
              --Environment "TEST" \
              --RepositoryDirectory . \
              --ItemsInScope "Notebook,Report,SemanticModel"
          fi
