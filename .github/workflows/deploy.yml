name: Deploy Notebook to Fabric

on:
  workflow_dispatch:   # manual trigger

env:
  resourceUrl: https://api.fabric.microsoft.com

jobs:
  Deploy_to_Test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install fabric-cicd
        run: |
          python -m pip install --upgrade pip
          pip install fabric-cicd
      - name: Authenticate to Azure
        run: |
          Install-Module -Name Az.Accounts -AllowClobber -Force
          $SecureStringPwd = ConvertTo-SecureString ${{ secrets.AZURE_CLIENT_SECRET }} -AsPlainText -Force
          $pscredential = New-Object System.Management.Automation.PSCredential(${{ secrets.AZURE_CLIENT_ID }}, $SecureStringPwd)
          Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant ${{ secrets.AZURE_TENANT_ID }}
          $fabricToken = (Get-AzAccessToken -ResourceUrl ${{ env.resourceUrl }}).Token
      - name: Deploy to Test
        run: python auth_spn_secret_AzDo.py --WorkspaceId ${{ vars.TestWorkspace }} --Environment "Test" --RepositoryDirectory "." --ItemsInScope "Notebook"

  Deploy_to_Prod:
    runs-on: windows-latest
    needs: Deploy_to_Test
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install fabric-cicd
        run: |
          python -m pip install --upgrade pip
          pip install fabric-cicd
      - name: Authenticate to Azure
        run: |
          Install-Module -Name Az.Accounts -AllowClobber -Force
          $SecureStringPwd = ConvertTo-SecureString ${{ secrets.AZURE_CLIENT_SECRET }} -AsPlainText -Force
          $pscredential = New-Object System.Management.Automation.PSCredential(${{ secrets.AZURE_CLIENT_ID }}, $SecureStringPwd)
          Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant ${{ secrets.AZURE_TENANT_ID }}
          $fabricToken = (Get-AzAccessToken -ResourceUrl ${{ env.resourceUrl }}).Token
      - name: Deploy to Prod
        run: python auth_spn_secret_AzDo.py --WorkspaceId ${{ vars.ProdWorkspace }} --Environment "Prod" --RepositoryDirectory "." --ItemsInScope "Notebook"
